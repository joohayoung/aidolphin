{% extends 'basehome.html' %}
{% load static %}

{% block style %}
    <link rel="stylesheet" href="{% static 'mainapp/home.css' %}" type="text/css"> 
{% endblock %}

{% block content %}
    <div id="banner">
        <img class='banner_img' src="{% static 'mainapp/image/banner3.png' %}" alt='banner'>
    </div>
    <div id='home_container'>
        <div id='banner_text'>
            Ai Dolphin<br>
            가장 빠르고 정확한 음향 분석과 검색 Ai<br>
            이제 음향은 dolphin으로!
        </div>
        <!-- 키워드 검색 -->
        <div class="search">
            <form action="{% url 'mainapp:search' %}" method="GET">
                {% csrf_token %}
                <input type="text" class="search-input" placeholder="search..." name="kw" value="{{kw|default_if_none:''}}">
                <input type="hidden" name='licenses[]' value="{{'all'}}">
                <button type="submit" class="search-icon">
                    <img src="{% static 'image/white_search@0.5x.png' %}" alt='search icon'>
                </button>
            </form>
        </div>
        <!-- 실시간검색 -->
        <div id='live'>
            <input type=checkbox id="chk-hear-mic"><label for="chk-hear-mic">마이크 소리 듣기</label>
            <button id="record">녹음</button>
            <button id="stop">정지</button>
            <div id="sound-clips">
                <form action="{% url 'mainapp:search' %}" method="GET">
                    {% csrf_token %}
                    <input type="hidden" name='licenses[]' value="{{'all'}}">
                    <input type="hidden" name='label' id='label_input'>
                    <input type="hidden" name='audio' id='audio_input'>
                    <button type="submit" id='realtime_search' style="display: none;">
                        search페이지로 넘어가는 제출(검색?)
                    </button>
                </form>
            </div>
            <script>
                const record = document.getElementById("record");
                const stop = document.getElementById("stop");
                const soundClips = document.getElementById("sound-clips");
                const chkHearMic = document.getElementById("chk-hear-mic");

                const audioCtx = new(window.AudioContext || window.webkitAudioContext)(); // 오디오 컨텍스트 정의
                const analyser = audioCtx.createAnalyser()

                function makeSound(stream) {
                    const source = audioCtx.createMediaStreamSource(stream);

                    source.connect(analyser);
                    analyser.connect(audioCtx.destination);
                };

                function getCookie(cname) { //csrf_token 가져오는 용도
                    var name = cname + "=";
                    var ca = document.cookie.split(';');
                    for(var i = 0; i <ca.length; i++) {
                        var c = ca[i];
                        while (c.charAt(0)==' ') {
                            c = c.substring(1);
                        }
                        if (c.indexOf(name) == 0) {
                            return c.substring(name.length,c.length);
                        }
                    }
                    return "";
                }
                // ======= 사용할 변수 함수 정의 =========

                if (navigator.mediaDevices) {
                    console.log('getUserMedia supported.'); //웹 콘솔창에 표시
                    const constraints = {
                        audio: true
                    };
                    let chunks = [];

                    navigator.mediaDevices.getUserMedia(constraints)
                        .then(stream => {

                            const mediaRecorder = new MediaRecorder(stream);
                            
                            chkHearMic.onchange = e => { // 마이크 소리듣기 옵션
                                if(e.target.checked == true) {
                                    audioCtx.resume();
                                    makeSound(stream);
                                } else {
                                    audioCtx.suspend();
                                };
                            };
                            
                            record.onclick = () => { //녹음버튼누르면 녹음시작
                                mediaRecorder.start();
                                console.log(mediaRecorder.state);
                                console.log("recorder started");
                                record.style.background = "red";
                                record.style.color = "black";
                            };

                            stop.onclick = () => { //stop버튼 무르면 중지
                                mediaRecorder.stop();
                                console.log(mediaRecorder.state);
                                console.log("recorder stopped");
                                record.style.background = "";
                                record.style.color = "";
                            };

                            mediaRecorder.onstop = e => { //mediaRecorder가 stop 상태가 되면 (stop 버튼 누르면)
                                console.log("data available after MediaRecorder.stop() called.");

                                // const clipName = prompt("오디오 파일 제목을 입력하세요.", new Date()); //이름지정안하면 날짜로 기본설정
                                const clipName = prompt("오디오 파일 제목을 입력하세요.", 'default'); // 날짜 형식오류나서 문자열로 변경

                                const clipContainer = document.createElement('article');
                                const clipLabel = document.createElement('p');
                                const audio = document.createElement('audio');
                                const deleteButton = document.createElement('button');
                                const submitButton = document.createElement('button'); //제출버튼 추가

                                clipContainer.classList.add('clip');
                                audio.setAttribute('controls', '');
                                deleteButton.innerHTML = "삭제";
                                submitButton.innerHTML = "확인(등록?)적당한 이름짓기";
                                clipLabel.innerHTML = clipName;
                                submitButton.setAttribute('type', 'submit')//제출버튼 속성추가

                                clipContainer.appendChild(audio);
                                clipContainer.appendChild(clipLabel);
                                clipContainer.appendChild(deleteButton);
                                clipContainer.appendChild(submitButton);//제출버튼 clipcontainer에 추가
                                soundClips.appendChild(clipContainer);

                                audio.controls = true;
                                const blob = new Blob(chunks, {'type': 'audio/ogg codecs=opus'});
                                
                                chunks = [];
                                const audioURL = URL.createObjectURL(blob);
                                audio.src = audioURL;
                                console.log("recorder stopped");

                                deleteButton.onclick = e => {
                                    evtTgt = e.target;
                                    evtTgt.parentNode.parentNode.removeChild(evtTgt.parentNode);
                                };

                                submitButton.onclick = () => { 
                                    submitButton.innerHTML = "등록중";
                                    submitButton.setAttribute('disabled', 'disabled')

                                    const fd = new FormData;
                                    fd.append('file', blob, clipName+".wav");

                                    var headers = new Headers();
                                    var csrftoken = getCookie('csrftoken');
                                    headers.append('X-CSRFToken', csrftoken);

                                    const audioinput = document.getElementById("audio_input");
                                    const labelinput = document.getElementById("label_input");

                                    const response = fetch("{% url 'mainapp:realtime' %}", {method:"POST", headers:headers, redirect:'follow', body:fd})
                                    .then(response => response.json())
                                    .then(function(res){
                                        console.log(res)
                                        audioinput.setAttribute('value', res['audio']);
                                        labelinput.setAttribute('value', res['label']);
                                    })
                                    .then(function(){
                                        const realtime_search = document.getElementById("realtime_search");
                                        realtime_search.style.display = "block";
                                    })
                                    .catch(err=> console.error(err));
                                };

                            };

                            mediaRecorder.ondataavailable = e => {
                                chunks.push(e.data);
                            };
                        })
                        .catch(err => {
                            console.log('The following error occurred: ' + err);
                        })
                };
            </script>
        </div>
        <!-- 파일검색 -->
        <div id='file'>
            <form method="POST" action="{% url 'mainapp:search' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="file" name="file" id="file_box" class="inputfile" accept="audio/*" capture="microphone" required/>
                <label for="file_box"><strong>Choose a file</strong></label>
                <input type="submit">
            </form>
        </div>
    </div>
{% endblock %}